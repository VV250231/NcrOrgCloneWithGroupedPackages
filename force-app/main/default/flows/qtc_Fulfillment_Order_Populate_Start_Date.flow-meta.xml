<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>53.0</apiVersion>
    <assignments>
        <name>Set_Order_Start_Date</name>
        <label>Set Order Start Date</label>
        <locationX>50</locationX>
        <locationY>654</locationY>
        <assignmentItems>
            <assignToReference>$Record.qtc_OrderStartDate__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>OrderAuthorizationAcceptedDatePlus30days</elementReference>
            </value>
        </assignmentItems>
    </assignments>
    <assignments>
        <name>Set_Order_Start_Date_0</name>
        <label>Set Order Start Date</label>
        <locationX>1086</locationX>
        <locationY>194</locationY>
        <assignmentItems>
            <assignToReference>$Record.qtc_OrderStartDate__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.qtc_ActualDeliveryDate__c</elementReference>
            </value>
        </assignmentItems>
    </assignments>
    <decisions>
        <description>Decision when Amendment Quanity Increase or Decrease</description>
        <name>Amendment_Increase_Decrease</name>
        <label>Amendment Increase/Decrease</label>
        <locationX>790</locationX>
        <locationY>504</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Amendment_Quantity_Increase</name>
            <conditionLogic>1 AND 2 AND (3 OR 4)</conditionLogic>
            <conditions>
                <leftValueReference>$Record.qtc_ERP_Order_Number__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Order_Interface_Status__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Order Booked</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.qtc_Quote__r.qtc_EligibleForERP__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>TRUE</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.qtc_Quote__r.qtc_EligibleForERP__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>TRUE MANUAL</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Publish_Quote_Order_Platform_Event</targetReference>
            </connector>
            <doesRequireRecordChangedToMeetCriteria>true</doesRequireRecordChangedToMeetCriteria>
            <label>Amendment Quantity Increase</label>
        </rules>
        <rules>
            <name>Amendment_Quantity_Decrease_Only</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.qtc_Quote__r.qtc_EligibleForERP__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <stringValue>TRUE</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.qtc_ErpRmaOrderNumber__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.qtc_Quote__r.qtc_EligibleForERP__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <stringValue>TRUE MANUAL</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Publish_Quote_Order_Platform_Event</targetReference>
            </connector>
            <doesRequireRecordChangedToMeetCriteria>true</doesRequireRecordChangedToMeetCriteria>
            <label>Amendment Quantity Decrease Only</label>
        </rules>
    </decisions>
    <decisions>
        <name>Update_Fulfillment_Order</name>
        <label>Update Fulfillment Order</label>
        <locationX>338</locationX>
        <locationY>447</locationY>
        <defaultConnectorLabel>Not Update Needed</defaultConnectorLabel>
        <rules>
            <name>Quote_Channel_Local_Office_Record_Type_Partner</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.qtc_Quote__r.qtc_Channel_Local_Office_Record_Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>PARTNER</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.qtc_ERP_Order_Number__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.qtc_Quote__r.SBQQ__Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Quote</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Set_OSD_Partner</targetReference>
            </connector>
            <doesRequireRecordChangedToMeetCriteria>true</doesRequireRecordChangedToMeetCriteria>
            <label>Partner</label>
        </rules>
        <rules>
            <name>Local_Office</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.qtc_Quote__r.qtc_Channel_Local_Office_Record_Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>LOCAL OFFICE</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.qtc_ActualDeliveryDate__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.qtc_Quote__r.SBQQ__Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Quote</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Set_OSD_LO</targetReference>
            </connector>
            <doesRequireRecordChangedToMeetCriteria>true</doesRequireRecordChangedToMeetCriteria>
            <label>Local Office</label>
        </rules>
        <rules>
            <name>OSD_Changed</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.qtc_OrderStartDate__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.qtc_ActualDeliveryDate__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.qtc_Quote__r.SBQQ__Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Quote</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_Quote_Start_Date</targetReference>
            </connector>
            <label>OSD Changed</label>
        </rules>
        <rules>
            <name>Amendment</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.qtc_Quote__r.SBQQ__Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Amendment</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.qtc_OrderStartDate__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Quote_Master_Contract</targetReference>
            </connector>
            <label>Amendment</label>
        </rules>
        <rules>
            <name>Default_Amendment</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.qtc_Quote__r.SBQQ__Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Amendment</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Amendment_Increase_Decrease</targetReference>
            </connector>
            <label>Default Amendment</label>
        </rules>
    </decisions>
    <description>Skip Flow Condition in Flow Entry Condition - 06-FEB-2023 DP250110
20220214 - Removed the Platform Event from the Local Office path
SFCPQBLG-842 - 20220210 - Combined the flow BLG Fulfillment Order After Update to this flow, publishes a quote ordered platform event
SFCPQBLG-990 - If Last Order Start Date in Past than calculated Fulfillment Order Start Date based On Legal document completion date.</description>
    <environments>Default</environments>
    <formulas>
        <name>f_FO_OSD</name>
        <dataType>Date</dataType>
        <expression>IF(TODAY() &lt; {!vOSD} , {!vOSD} , IF(ISBLANK({!fLegalDocCompletedDate}), null, 
DATE( 
YEAR({!fLegalDocCompletedDate}) + IF(MONTH({!fLegalDocCompletedDate}) + 1 &gt; 12 , 1 , 0),
IF(MONTH({!fLegalDocCompletedDate}) + 1 &gt; 12, 1 , MONTH({!fLegalDocCompletedDate}) + 1),
1)) 
)</expression>
    </formulas>
    <formulas>
        <name>fLegalDocCompletedDate</name>
        <dataType>Date</dataType>
        <expression>IF(ISBLANK({!$Record.qtc_Quote__r.qtc_SyncFulfillmentOrderDateTime__c}), null, DATEVALUE({!$Record.qtc_Quote__r.qtc_SyncFulfillmentOrderDateTime__c}))</expression>
    </formulas>
    <formulas>
        <name>OrderAuthorizationAcceptedDatePlus30days</name>
        <dataType>Date</dataType>
        <expression>DATEVALUE({!$Record.qtc_QuoteShipAuthDate__c}) +30</expression>
    </formulas>
    <formulas>
        <name>SetOrderStartDatetoToday</name>
        <dataType>Date</dataType>
        <expression>{!$Flow.CurrentDateTime}</expression>
    </formulas>
    <interviewLabel>qtc Populate Start Date {!$Flow.CurrentDateTime}</interviewLabel>
    <label>qtc Fulfillment Order Populate Start Date</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordCreates>
        <description>Creates an Quote Ordered Platform Event</description>
        <name>Publish_Quote_Order_Platform_Event</name>
        <label>Publish Quote Order Platform Event</label>
        <locationX>1054</locationX>
        <locationY>500</locationY>
        <inputAssignments>
            <field>qtcQuoteId__c</field>
            <value>
                <elementReference>$Record.qtc_Quote__c</elementReference>
            </value>
        </inputAssignments>
        <object>Quote_Ordered__e</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <recordLookups>
        <name>Get_Quote_Master_Contract</name>
        <label>Get Most Recent OSD</label>
        <locationX>636</locationX>
        <locationY>276</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Set_FO_OSD</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.qtc_Quote__r.SBQQ__MasterContract__r.SBQQ__Order__c</elementReference>
            </value>
        </filters>
        <object>Order</object>
        <outputAssignments>
            <assignToReference>vOSD</assignToReference>
            <field>EffectiveDate</field>
        </outputAssignments>
    </recordLookups>
    <recordUpdates>
        <name>Set_FO_OSD</name>
        <label>Set FO OSD</label>
        <locationX>798</locationX>
        <locationY>273</locationY>
        <connector>
            <targetReference>Amendment_Increase_Decrease</targetReference>
        </connector>
        <inputAssignments>
            <field>qtc_OrderStartDate__c</field>
            <value>
                <elementReference>f_FO_OSD</elementReference>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Set_OSD_LO</name>
        <label>Set OSD LO</label>
        <locationX>502</locationX>
        <locationY>786</locationY>
        <connector>
            <targetReference>Update_Quote</targetReference>
        </connector>
        <inputAssignments>
            <field>qtc_OrderStartDate__c</field>
            <value>
                <elementReference>$Record.qtc_ActualDeliveryDate__c</elementReference>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Set_OSD_Partner</name>
        <label>Set OSD Partner</label>
        <locationX>322</locationX>
        <locationY>659</locationY>
        <connector>
            <targetReference>Update_Quote_Start_Date_0</targetReference>
        </connector>
        <inputAssignments>
            <field>qtc_OrderStartDate__c</field>
            <value>
                <elementReference>OrderAuthorizationAcceptedDatePlus30days</elementReference>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Quote</name>
        <label>Update Quote</label>
        <locationX>640</locationX>
        <locationY>781</locationY>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.qtc_Quote__c</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>SBQQ__StartDate__c</field>
            <value>
                <elementReference>$Record.qtc_ActualDeliveryDate__c</elementReference>
            </value>
        </inputAssignments>
        <object>SBQQ__Quote__c</object>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Quote_Start_Date</name>
        <label>Update Quote Start Date</label>
        <locationX>104</locationX>
        <locationY>432</locationY>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.qtc_Quote__c</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>SBQQ__StartDate__c</field>
            <value>
                <elementReference>$Record.qtc_OrderStartDate__c</elementReference>
            </value>
        </inputAssignments>
        <object>SBQQ__Quote__c</object>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Quote_Start_Date_0</name>
        <label>Update Quote Start Date</label>
        <locationX>325</locationX>
        <locationY>812</locationY>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.qtc_Quote__c</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>SBQQ__StartDate__c</field>
            <value>
                <elementReference>$Record.qtc_OrderStartDate__c</elementReference>
            </value>
        </inputAssignments>
        <object>SBQQ__Quote__c</object>
    </recordUpdates>
    <start>
        <locationX>197</locationX>
        <locationY>55</locationY>
        <connector>
            <targetReference>Update_Fulfillment_Order</targetReference>
        </connector>
        <filterFormula>NOT({!$Setup.Automation_Setting__c.Skip_Flow__c})</filterFormula>
        <object>qtc_FulfillmentOrder__c</object>
        <recordTriggerType>Update</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <variables>
        <name>vOSD</name>
        <dataType>Date</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
